; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 5
; RUN: opt -passes=instcombine %s -S -o - | FileCheck %s
; RUN: opt -passes=instcombine %s -S -o - --try-experimental-debuginfo-iterators | FileCheck %s
; Verify that the eliminated instructions (bitcast, gep, load) are salvaged into
; a DIExpression.
;
; Originally created from the following C source and then heavily isolated/reduced.
;
; struct entry {
;   struct entry *next;
; };
; void scan(struct entry *queue, struct entry *end)
; {
;   struct entry *entry;
;   for (entry = (struct entry *)((char *)(queue->next) - 8);
;        &entry->next == end;
;        entry = (struct entry *)((char *)(entry->next) - 8)) {
;   }
; }

; ModuleID = '<stdin>'
source_filename = "test.c"
target datalayout = "e-m:o-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-apple-macosx10.12.0"

%struct.entry = type { ptr }

; This salvage can't currently occur safely (PR40628), however if/when that's
; ever fixed, then this is definitely a piece of test coverage that should
; be maintained.
define void @salvage_load(ptr %queue) local_unnamed_addr #0 !dbg !14 {
; CHECK-LABEL: define void @salvage_load(
; CHECK-SAME: ptr [[QUEUE:%.*]]) local_unnamed_addr #[[ATTR0:[0-9]+]] !dbg [[DBG14:![0-9]+]] {
; CHECK-NEXT:  [[ENTRY:.*:]]
; CHECK-NEXT:      #dbg_value(ptr poison, [[META18:![0-9]+]], !DIExpression(DW_OP_plus_uconst, 0), [[META19:![0-9]+]])
; CHECK-NEXT:    ret void, !dbg [[DBG20:![0-9]+]]
;
entry:
  %im_not_dead = alloca ptr
  %0 = load ptr, ptr %queue, align 8, !dbg !19
  %1 = load ptr, ptr %queue, align 8, !dbg !19
  call void @llvm.dbg.value(metadata ptr %1, metadata !18, metadata !20), !dbg !19
  store ptr %1, ptr %im_not_dead, align 8
  ret void, !dbg !21
}

define void @salvage_bitcast(ptr %queue) local_unnamed_addr #0 !dbg !22 {
; CHECK-LABEL: define void @salvage_bitcast(
; CHECK-SAME: ptr [[QUEUE:%.*]]) local_unnamed_addr #[[ATTR0]] !dbg [[DBG21:![0-9]+]] {
; CHECK-NEXT:  [[ENTRY:.*:]]
; CHECK-NEXT:      #dbg_value(ptr [[QUEUE]], [[META22:![0-9]+]], !DIExpression(DW_OP_plus_uconst, 0), [[META23:![0-9]+]])
; CHECK-NEXT:    ret void, !dbg [[META23]]
;
entry:
  %im_not_dead = alloca ptr
  call void @llvm.dbg.value(metadata ptr %queue, metadata !24, metadata !20), !dbg !23
  store ptr %queue, ptr %im_not_dead, align 8
  ret void, !dbg !23
}

define void @salvage_gep0(ptr %queue, ptr %end) local_unnamed_addr #0 !dbg !25 {
; CHECK-LABEL: define void @salvage_gep0(
; CHECK-SAME: ptr [[QUEUE:%.*]], ptr [[END:%.*]]) local_unnamed_addr #[[ATTR0]] !dbg [[DBG24:![0-9]+]] {
; CHECK-NEXT:  [[ENTRY:.*:]]
; CHECK-NEXT:      #dbg_value(ptr [[QUEUE]], [[META25:![0-9]+]], !DIExpression(DW_OP_constu, 8, DW_OP_minus, DW_OP_stack_value), [[META26:![0-9]+]])
; CHECK-NEXT:    ret void, !dbg [[META26]]
;
entry:
  %im_not_dead = alloca ptr
  %0 = getelementptr inbounds %struct.entry, ptr %queue, i32 -1, i32 0, !dbg !26
  %1 = getelementptr inbounds %struct.entry, ptr %queue, i32 -1, i32 0, !dbg !26
  call void @llvm.dbg.value(metadata ptr %1, metadata !27, metadata !20), !dbg !26
  store ptr %1, ptr %im_not_dead, align 8
  ret void, !dbg !26
}

define void @salvage_gep1(ptr %queue, ptr %end) local_unnamed_addr #0 !dbg !28 {
; CHECK-LABEL: define void @salvage_gep1(
; CHECK-SAME: ptr [[QUEUE:%.*]], ptr [[END:%.*]]) local_unnamed_addr #[[ATTR0]] !dbg [[DBG27:![0-9]+]] {
; CHECK-NEXT:  [[ENTRY:.*:]]
; CHECK-NEXT:      #dbg_value(ptr [[QUEUE]], [[META28:![0-9]+]], !DIExpression(DW_OP_constu, 8, DW_OP_minus, DW_OP_stack_value, DW_OP_LLVM_fragment, 0, 32), [[META29:![0-9]+]])
; CHECK-NEXT:    ret void, !dbg [[META29]]
;
entry:
  %im_not_dead = alloca ptr
  %0 = getelementptr inbounds %struct.entry, ptr %queue, i32 -1, i32 0, !dbg !29
  %1 = getelementptr inbounds %struct.entry, ptr %queue, i32 -1, i32 0, !dbg !29
  call void @llvm.dbg.value(metadata ptr %1, metadata !30, metadata !DIExpression(DW_OP_LLVM_fragment, 0, 32)), !dbg !29
  store ptr %1, ptr %im_not_dead, align 8
  ret void, !dbg !29
}

define void @salvage_gep2(ptr %queue, ptr %end) local_unnamed_addr #0 !dbg !31 {
; CHECK-LABEL: define void @salvage_gep2(
; CHECK-SAME: ptr [[QUEUE:%.*]], ptr [[END:%.*]]) local_unnamed_addr #[[ATTR0]] !dbg [[DBG30:![0-9]+]] {
; CHECK-NEXT:  [[ENTRY:.*:]]
; CHECK-NEXT:      #dbg_value(ptr [[QUEUE]], [[META31:![0-9]+]], !DIExpression(DW_OP_constu, 8, DW_OP_minus, DW_OP_stack_value), [[META32:![0-9]+]])
; CHECK-NEXT:    ret void, !dbg [[META32]]
;
entry:
  %im_not_dead = alloca ptr
  %0 = getelementptr inbounds %struct.entry, ptr %queue, i32 -1, i32 0, !dbg !32
  %1 = getelementptr inbounds %struct.entry, ptr %queue, i32 -1, i32 0, !dbg !32
  call void @llvm.dbg.value(metadata ptr %1, metadata !33, metadata !DIExpression(DW_OP_stack_value)), !dbg !32
  store ptr %1, ptr %im_not_dead, align 8
  ret void, !dbg !32
}

; Function Attrs: nounwind readnone
declare void @llvm.dbg.value(metadata, metadata, metadata) #1

attributes #0 = { nounwind ssp uwtable }
attributes #1 = { nounwind readnone }

!llvm.dbg.cu = !{!0}
!llvm.module.flags = !{!10, !11, !12}
!llvm.ident = !{!13}

!0 = distinct !DICompileUnit(language: DW_LANG_C99, file: !1, producer: "clang version 5.0.0 (trunk 297628) (llvm/trunk 297643)", isOptimized: true, runtimeVersion: 0, emissionKind: FullDebug, enums: !2, retainedTypes: !3)
!1 = !DIFile(filename: "test.c", directory: "/")
!2 = !{}
!3 = !{!4, !8}
!4 = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: !5, size: 64)
!5 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: "entry", file: !1, line: 1, size: 64, elements: !6)
!6 = !{!7}
!7 = !DIDerivedType(tag: DW_TAG_member, name: "next", scope: !5, file: !1, line: 2, baseType: !4, size: 64)
!8 = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: !9, size: 64)
!9 = !DIBasicType(name: "char", size: 8, encoding: DW_ATE_signed_char)
!10 = !{i32 2, !"Dwarf Version", i32 4}
!11 = !{i32 2, !"Debug Info Version", i32 3}
!12 = !{i32 1, !"PIC Level", i32 2}
!13 = !{!"clang version 5.0.0 (trunk 297628) (llvm/trunk 297643)"}
!14 = distinct !DISubprogram(name: "scan", scope: !1, file: !1, line: 4, type: !15, isLocal: false, isDefinition: true, scopeLine: 5, flags: DIFlagPrototyped, isOptimized: true, unit: !0, retainedNodes: !17)
!15 = !DISubroutineType(types: !16)
!16 = !{null, !4, !4}
!17 = !{!18}
!18 = !DILocalVariable(name: "entry", scope: !14, file: !1, line: 6, type: !4)
!19 = !DILocation(line: 6, column: 17, scope: !14)
!20 = !DIExpression(DW_OP_plus_uconst, 0)
!21 = !DILocation(line: 11, column: 1, scope: !14)
!22 = distinct !DISubprogram(name: "scan", scope: !1, file: !1, line: 4, type: !15, isLocal: false, isDefinition: true, scopeLine: 5, flags: DIFlagPrototyped, isOptimized: true, unit: !0, retainedNodes: !17)
!23 = !DILocation(line: 6, column: 17, scope: !22)
!24 = !DILocalVariable(name: "entry", scope: !22, file: !1, line: 6, type: !4)
!25 = distinct !DISubprogram(name: "scan", scope: !1, file: !1, line: 4, type: !15, isLocal: false, isDefinition: true, scopeLine: 5, flags: DIFlagPrototyped, isOptimized: true, unit: !0, retainedNodes: !17)
!26 = !DILocation(line: 6, column: 17, scope: !25)
!27 = !DILocalVariable(name: "entry", scope: !25, file: !1, line: 6, type: !4)
!28 = distinct !DISubprogram(name: "scan", scope: !1, file: !1, line: 4, type: !15, isLocal: false, isDefinition: true, scopeLine: 5, flags: DIFlagPrototyped, isOptimized: true, unit: !0, retainedNodes: !17)
!29 = !DILocation(line: 6, column: 17, scope: !28)
!30 = !DILocalVariable(name: "entry", scope: !28, file: !1, line: 6, type: !4)
!31 = distinct !DISubprogram(name: "scan", scope: !1, file: !1, line: 4, type: !15, isLocal: false, isDefinition: true, scopeLine: 5, flags: DIFlagPrototyped, isOptimized: true, unit: !0, retainedNodes: !17)
!32 = !DILocation(line: 6, column: 17, scope: !31)
!33 = !DILocalVariable(name: "entry", scope: !31, file: !1, line: 6, type: !4)
;.
; CHECK: [[META0:![0-9]+]] = distinct !DICompileUnit(language: DW_LANG_C99, file: [[META1:![0-9]+]], producer: "{{.*}}clang version {{.*}} (llvm/trunk 297643)", isOptimized: true, runtimeVersion: 0, emissionKind: FullDebug, enums: [[META2:![0-9]+]], retainedTypes: [[META3:![0-9]+]])
; CHECK: [[META1]] = !DIFile(filename: "test.c", directory: {{.*}})
; CHECK: [[META2]] = !{}
; CHECK: [[META3]] = !{[[META4:![0-9]+]], [[META8:![0-9]+]]}
; CHECK: [[META4]] = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: [[META5:![0-9]+]], size: 64)
; CHECK: [[META5]] = distinct !DICompositeType(tag: DW_TAG_structure_type, name: "entry", file: [[META1]], line: 1, size: 64, elements: [[META6:![0-9]+]])
; CHECK: [[META6]] = !{[[META7:![0-9]+]]}
; CHECK: [[META7]] = !DIDerivedType(tag: DW_TAG_member, name: "next", scope: [[META5]], file: [[META1]], line: 2, baseType: [[META4]], size: 64)
; CHECK: [[META8]] = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: [[META9:![0-9]+]], size: 64)
; CHECK: [[META9]] = !DIBasicType(name: "char", size: 8, encoding: DW_ATE_signed_char)
; CHECK: [[DBG14]] = distinct !DISubprogram(name: "scan", scope: [[META1]], file: [[META1]], line: 4, type: [[META15:![0-9]+]], scopeLine: 5, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: [[META0]], retainedNodes: [[META17:![0-9]+]])
; CHECK: [[META15]] = !DISubroutineType(types: [[META16:![0-9]+]])
; CHECK: [[META16]] = !{null, [[META4]], [[META4]]}
; CHECK: [[META17]] = !{[[META18]]}
; CHECK: [[META18]] = !DILocalVariable(name: "entry", scope: [[DBG14]], file: [[META1]], line: 6, type: [[META4]])
; CHECK: [[META19]] = !DILocation(line: 6, column: 17, scope: [[DBG14]])
; CHECK: [[DBG20]] = !DILocation(line: 11, column: 1, scope: [[DBG14]])
; CHECK: [[DBG21]] = distinct !DISubprogram(name: "scan", scope: [[META1]], file: [[META1]], line: 4, type: [[META15]], scopeLine: 5, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: [[META0]], retainedNodes: [[META17]])
; CHECK: [[META22]] = !DILocalVariable(name: "entry", scope: [[DBG21]], file: [[META1]], line: 6, type: [[META4]])
; CHECK: [[META23]] = !DILocation(line: 6, column: 17, scope: [[DBG21]])
; CHECK: [[DBG24]] = distinct !DISubprogram(name: "scan", scope: [[META1]], file: [[META1]], line: 4, type: [[META15]], scopeLine: 5, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: [[META0]], retainedNodes: [[META17]])
; CHECK: [[META25]] = !DILocalVariable(name: "entry", scope: [[DBG24]], file: [[META1]], line: 6, type: [[META4]])
; CHECK: [[META26]] = !DILocation(line: 6, column: 17, scope: [[DBG24]])
; CHECK: [[DBG27]] = distinct !DISubprogram(name: "scan", scope: [[META1]], file: [[META1]], line: 4, type: [[META15]], scopeLine: 5, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: [[META0]], retainedNodes: [[META17]])
; CHECK: [[META28]] = !DILocalVariable(name: "entry", scope: [[DBG27]], file: [[META1]], line: 6, type: [[META4]])
; CHECK: [[META29]] = !DILocation(line: 6, column: 17, scope: [[DBG27]])
; CHECK: [[DBG30]] = distinct !DISubprogram(name: "scan", scope: [[META1]], file: [[META1]], line: 4, type: [[META15]], scopeLine: 5, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: [[META0]], retainedNodes: [[META17]])
; CHECK: [[META31]] = !DILocalVariable(name: "entry", scope: [[DBG30]], file: [[META1]], line: 6, type: [[META4]])
; CHECK: [[META32]] = !DILocation(line: 6, column: 17, scope: [[DBG30]])
;.
