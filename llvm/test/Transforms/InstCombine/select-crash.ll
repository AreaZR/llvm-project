; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 5
; RUN: opt < %s -passes=instcombine -S | FileCheck %s
; Formerly crashed, PR8490.

define fastcc double @gimp_operation_color_balance_map(float %value, double %highlights) nounwind readnone inlinehint {
; CHECK-LABEL: define fastcc double @gimp_operation_color_balance_map(
; CHECK-SAME: float [[VALUE:%.*]], double [[HIGHLIGHTS:%.*]]) #[[ATTR0:[0-9]+]] {
; CHECK-NEXT:  [[ENTRY:.*:]]
; CHECK-NEXT:    [[CONV:%.*]] = fpext float [[VALUE]] to double
; CHECK-NEXT:    [[DIV:%.*]] = fmul double [[CONV]], 6.250000e-02
; CHECK-NEXT:    [[ADD:%.*]] = fadd double [[DIV]], 1.000000e+00
; CHECK-NEXT:    [[DIV1:%.*]] = fdiv double 1.000000e+00, [[ADD]]
; CHECK-NEXT:    [[SUB:%.*]] = fsub double 1.075000e+00, [[DIV1]]
; CHECK-NEXT:    [[CMP86:%.*]] = fcmp ogt double [[HIGHLIGHTS]], 0.000000e+00
; CHECK-NEXT:    [[TMP0:%.*]] = fneg double [[SUB]]
; CHECK-NEXT:    [[COND90_P:%.*]] = select i1 [[CMP86]], double [[TMP0]], double [[SUB]]
; CHECK-NEXT:    [[COND90:%.*]] = fadd double [[COND90_P]], 1.000000e+00
; CHECK-NEXT:    [[MUL91:%.*]] = fmul double [[COND90]], [[HIGHLIGHTS]]
; CHECK-NEXT:    [[ADD94:%.*]] = fadd double [[MUL91]], [[MUL91]]
; CHECK-NEXT:    ret double [[ADD94]]
;
entry:
  %conv = fpext float %value to double
  %div = fdiv double %conv, 1.600000e+01
  %add = fadd double %div, 1.000000e+00
  %div1 = fdiv double 1.000000e+00, %add
  %sub = fsub double 1.075000e+00, %div1
  %sub24 = fsub double 1.000000e+00, %sub
  %add26 = fadd double %sub, 1.000000e+00
  %cmp86 = fcmp ogt double %highlights, 0.000000e+00
  %cond90 = select i1 %cmp86, double %sub24, double %add26
  %mul91 = fmul double %highlights, %cond90
  %add94 = fadd double %mul91, %mul91
  ret double %add94
}

; PR10180: same crash, but with vectors
define <4 x float> @foo(i1 %b, <4 x float> %x, <4 x float> %y, <4 x float> %z) {
; CHECK-LABEL: define <4 x float> @foo(
; CHECK-SAME: i1 [[B:%.*]], <4 x float> [[X:%.*]], <4 x float> [[Y:%.*]], <4 x float> [[Z:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = fneg <4 x float> [[Z]]
; CHECK-NEXT:    [[SEL_P:%.*]] = select i1 [[B]], <4 x float> [[Y]], <4 x float> [[TMP1]]
; CHECK-NEXT:    [[SEL:%.*]] = fadd <4 x float> [[SEL_P]], [[X]]
; CHECK-NEXT:    ret <4 x float> [[SEL]]
;
  %a = fadd <4 x float> %x, %y
  %sub = fsub <4 x float> %x, %z
  %sel = select i1 %b, <4 x float> %a, <4 x float> %sub
  ret <4 x float> %sel
}
